# Antiplagiat System (Microservices)

Информационная система для автоматизированного приема и проверки студенческих работ на наличие заимствований (плагиата). Система построена на основе микросервисной архитектуры с использованием языка C++, контейнеризации Docker и базы данных PostgreSQL.

## Технологический стек

*   **Язык программирования:** C++17
*   **Веб-фреймворк:** Crow (микрофреймворк для C++)
*   **HTTP-клиент:** CPR (C++ Requests, обертка над libcurl)
*   **База данных:** PostgreSQL 15
*   **Сборка и контейнеризация:** CMake, Docker, Docker Compose
*   **Внешние API:** QuickChart (для визуализации облака слов)

## Архитектура системы

Система состоит из трех основных бизнес-сервисов и базы данных, объединенных в единую сеть Docker. Взаимодействие между сервисами осуществляется синхронно по протоколу HTTP (REST API).

### 1. API Gateway Service (Gateway)
*   **Роль:** Единая точка входа для внешних клиентов.
*   **Порт:** 8000 (доступен извне).
*   **Ответственность:** Маршрутизация запросов к соответствующим внутренним микросервисам. Скрывает топологию внутренней сети от клиента.

### 2. File Storing Service (Storage)
*   **Роль:** Управление файлами и метаданными.
*   **Порт:** 8080 (внутренний).
*   **Ответственность:**
    *   Прием файлов от Gateway.
    *   Сохранение файлов на диск (в общий Docker Volume).
    *   Запись метаданных о сдаче (студент, задание, время) в таблицу `submissions`.
    *   Инициация синхронной проверки в Analysis Service.

### 3. File Analysis Service (Analysis)
*   **Роль:** Бизнес-логика проверки и генерация отчетов.
*   **Порт:** 8080 (внутренний).
*   **Ответственность:**
    *   Сравнение текста текущей работы с базой ранее сданных работ.
    *   Формирование отчета о плагиате и запись в таблицу `reports`.
    *   Генерация ссылки на облако слов (Word Cloud).
    *   Предоставление данных для отчетов преподавателю.

### 4. Database & Storage
*   **PostgreSQL:** Хранит информацию о сдачах и результаты проверок.
*   **Shared Volume (`uploads_data`):** Общее дисковое пространство, примонтированное к контейнерам Storage и Analysis, позволяющее обоим сервисам иметь доступ к физическим файлам.

## Алгоритм определения плагиата

В текущей версии (MVP) реализован алгоритм прямого сравнения текстов.
Система считает работу плагиатом, если выполняются следующие условия:
1.  Существует другая работа с таким же идентификатором задания (`task_id`).
2.  Идентификатор загрузки (`id`) найденной работы меньше текущего (то есть она была сдана раньше).
3.  Имя студента отличается от имени автора текущей работы (исключение самоцитирования).
4.  Содержимое файлов полностью идентично.

При обнаружении совпадения в отчете фиксируется ID оригинальной работы (`similar_to_id`).

## Инструкция по запуску

Для развертывания системы требуется установленный Docker и Docker Compose.

1.  Откройте терминал в корневой папке проекта.
2.  Выполните сборку и запуск контейнеров:

```bash
docker compose up --build -d
```

После успешного запуска API будет доступно по адресу `http://localhost:8000`.

## Пользовательские сценарии и API

## Важно: Тестирование через Postman

В папке `postman` находится коллекция запросов и тестовые файлы.

1.  Импортируйте файл `postman/Antiplagiat.postman_collection.json` в Postman.
2.  **Важно:** Так как Postman сохраняет абсолютные пути к файлам, при выполнении запросов `Upload` вам нужно заново выбрать файлы из папки `postman/files` в поле `Body` -> `form-data` -> `file`.

Ниже описаны технические сценарии взаимодействия с системой.

### 1. Отправка работы на проверку (Студент)

**Запрос:** `POST /api/upload`
**Content-Type:** `multipart/form-data`

Параметры:
*   `student` (text): Фамилия студента.
*   `task_id` (text): Идентификатор задания (например, Lab1).
*   `file` (file): Текстовый файл с решением.

**Внутренний поток данных:**
1.  Gateway пересылает запрос в Storage Service.
2.  Storage Service сохраняет файл и создает запись в БД.
3.  Storage Service делает синхронный запрос в Analysis Service (`POST /internal/analyze`).
4.  Analysis Service проводит сверку и возвращает результат.
5.  Ответ возвращается по цепочке клиенту.

**Пример ответа (Успех):**
```json
{
    "filename": "Math_Lab5_Ivanov.txt",
    "submission_id": 1,
    "status": "checked",
    "is_plagiarism": false
}
```

### 2. Получение списка работ по заданию (Преподаватель)

**Запрос:** `GET /api/reports/task/{task_id}`

Позволяет увидеть всех студентов, сдавших определенную работу, и статус их проверки.

**Пример ответа:**
```json
{
    "task_id": "Math_Lab5",
    "reports": [
        {
            "submission_id": 2,
            "student": "Petrov",
            "is_plagiarism": true,
            "timestamp": "2023-10-27 10:00:00"
        },
        {
            "submission_id": 1,
            "student": "Ivanov",
            "is_plagiarism": false,
            "timestamp": "2023-10-27 09:00:00"
        }
    ]
}
```

### 3. Получение детального отчета (Преподаватель)

**Запрос:** `GET /api/reports/{submission_id}`

Возвращает полную информацию о конкретной сдаче, включая ссылку на оригинал (если плагиат) и визуализацию.

**Пример ответа:**
```json
{
    "submission_id": 2,
    "student": "Petrov",
    "task_id": "Math_Lab5",
    "is_plagiarism": true,
    "similar_to_id": 1,
    "wordcloud_url": "https://quickchart.io/wordcloud?text=..."
}
```

## Обработка ошибок и отказоустойчивость

Система реализует механизм частичной доступности (Graceful Degradation) и самовосстановления (Self-healing).

1.  **Сценарий падения Analysis Service:**
    Если при загрузке файла (`POST /api/upload`) сервис анализа недоступен, Storage Service не прерывает работу с ошибкой 500. Вместо этого он сохраняет файл и возвращает клиенту статус `uploaded_but_check_failed`. Файл считается принятым, но непроверенным.

2.  **Отложенная проверка (Lazy Loading):**
    При запросе отчета преподавателем (`GET /api/reports/...`), Analysis Service проверяет наличие готового отчета в базе данных. Если отчет отсутствует (например, из-за сбоя при загрузке), система автоматически запускает анализ в реальном времени, сохраняет результат и возвращает актуальные данные. Это гарантирует, что ни одна работа не останется без проверки.

## Дополнительная функциональность (Визуализация)

В рамках выполнения требований на высшую оценку реализована интеграция с API QuickChart.
При запросе детального отчета Analysis Service считывает файл студента, формирует URL и добавляет его в поле `wordcloud_url`. Переход по ссылке генерирует изображение "Облако слов" на основе частотного анализа текста работы.
